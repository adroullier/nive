
import time
import unittest
from StringIO import StringIO

from Poolyx.utils.path import DvPath

from Poolyx.definitions import *
from Poolyx.security import User
from Poolyx.components.objects.base import ApplicationBase

from db_app import *
from tpoolyx import appTest_db
from tcontainer import containerTest_db
from tobjects import objTest_db, objToolTest_db, objWfTest_db


# real database test configuration
# change these to fit your system
ENABLE_MYSQL_TESTS = True
try:
    import MySQLdb
except ImportError:
    ENABLE_MYSQL_TESTS = False

dbconfMySql = DatabaseConf(
    dbName = "ut_poolyx2",
    fileRoot = "/var/tmp/poolyx2",
    context = "MySql",
    host = "localhost",
    user = "root"
)

if not ENABLE_MYSQL_TESTS:
    class utc:
        pass
    uTestCase = utc
else:
    uTestCase = unittest.TestCase
    
    
def myapp():
    a = ApplicationBase()
    a.Register(appconf)
    a.Register(dbconfMySql)
    p = Portal()
    p.Register(a, "poolyx")
    a.Startup(None)
    dbfile = DvPath(a.dbConfiguration.fileRoot)
    if not dbfile.IsDirectory():
        dbfile.CreateDirectories()
    try:
        a.Query("select id from pool_meta where id=1")
        a.Query("select id from data1 where id=1")
        a.Query("select id from data2 where id=1")
        a.Query("select id from data3 where id=1")
        a.Query("select id from pool_files where id=1")
    except:
        a.GetTool("Poolyx.components.tools.dbStructureUpdater")()
    return a


class myappTest_db(appTest_db, uTestCase):

    def setUp(self):
        #emptypool()
        self.app = myapp()
        self.remove=[]


class mycontainerTest_db(containerTest_db, uTestCase):

    def setUp(self):
        #emptypool()
        self.app = myapp()
        self.remove=[]

class myobjTest_db(objTest_db, uTestCase):

    def setUp(self):
        #emptypool()
        self.app = myapp()
        self.remove=[]

#class myobjToolTest_db(objToolTest_db, uTestCase):
#
#    def setUp(self):
#        #emptypool()
#        self.app = myapp()

#class myobjWfTest_db(objWfTest_db, uTestCase):
#
#    def setUp(self):
#        #emptypool()
#        self.app = myapp()



if __name__ == '__main__':
    unittest.main()



